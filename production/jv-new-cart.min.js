(function () {

    try {

        let NewCart = {
            init: () => {
                // miniCartFunctions
                NewCart.appendToBody();
                NewCart.start(); 
                NewCart.events();
                NewCart.qtdProductAdega();
            },
            windowOnload: () => {},
            ajaxStop: () => {},
            close: () => {
                $('.mini-cart-wrapper').removeClass('active');
                $('.mini-cart-close-overlay').fadeOut(400, 'linear');
            },
            open: () => {
                $('.mini-cart-wrapper').addClass('active');
                $('.mini-cart-close-overlay').fadeIn(400, 'linear');
            },
            start: () => {
                $('.buy-button.buy-button-ref').addClass('buy-btn-ldng');
                vtexjs.checkout.getOrderForm().done(function(orderForm) {
                    console.log('getOrderForm passed');
                    NewCart.update(orderForm);
                });
            },
            appendToBody: () => {
                $('body').append('<div class="mini-cart-wrapper">' +
                    '<div class="mini-cart-close-overlay"></div>' +
        
                    '<div class="mini-cart-sidebar-container">' +
                    '<div class="mini-cart-content">' +
        
                    '<div class="mini-cart-title"><div class="mini-cart-close"></div><span>SACOLA</span><span id="mini-cart-removeall" style="width: auto;text-transform: uppercase;font-weight: 600;text-decoration: underline;font-size: 10px;cursor: pointer;color: #737373;position: absolute;right: 5px;">Limpar sacola</span></div>' +
                    '<div class="mini-cart-products">' +
        
                    '</div>' +
                    '<div class="mini-cart-bottom">' +
                    '<p class="mini-cart-bottom-total">TOTAL<span></span></p>' +
                    '<p class="mini-cart-bottom-frete" style="padding-top: 7px;">FRETE<span style="color: #4AAE51;">GRÁTIS</span></p>' +
                    '<p class="mini-cart-bottom-msg"></p>' +
        
                    '<a class="mini-cart-bottom-checkout" href="/checkout/#/cart">REVISAR A COMPRA</a>' +
                    '</div>' +
        
                    '<div class="msg-empty">' +
                    '<p>Sua sacola está vazia.</p>' +
                    '<a class="btn-choose-more" href="/">' +
                    '<span>Escolher produtos</span>' +
                    '</a>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>')
            },
            update: (orderForm) => { 
                items = orderForm.items;
                $('.mini-cart-icon-mob-qtd').html('');
                numItemsInCart = 0;
                if (items.length > 0) {
                    numItemsInCart = items.length;
                    $('.mini-cart-wrapper').removeClass('empty');
                    $('.mini-cart-products').html('');
                    $('.mini-cart-products').append('<ul class="products-list"></ul>');
                    var rewardTotal = 0;
                    var donationTotal = 0;
        
                    items.forEach(function(item, i) {
                        sku = item.id;
                        skuName = item.skuName;
                        price = item.price;
                        sellingPrice = item.sellingPrice;
                        url = item.detailUrl;
                        imgUrl = item.imageUrl;
                        qtd = item.quantity;
                        //reward = item.rewardValue;
                        //rewardTotal += reward;
                        //if (reward > 0) { donationTotal += sellingPrice * 0.1}
        
                        $('.products-list').prepend(
                            '<li class="products-list-item" data-sku-id="' + sku + '" data-product-index="' + i + '">' +
                            '<div class="products-list-item-wrap">' +
                            '<div class="product-image">' +
                            '<a class="product-link" href="' + url + '">' +
                            '<img src="' + imgUrl + '">' +
                            '</a>' +
                            '</div>' +
                            '<div class="product-info">' +
        
                            '<div class="product-name">' +
                            '<a class="product-link" href="' + url + '">' + skuName + '</a>' +
                            '</div>' +
        
                            '<div class="product-qtd-price">' +
                            '<span class="product-qtd">Qtd: ' + qtd + '</span>' +
                            '<span class="product-price">' + NewCart.fixPrice(sellingPrice) + '</span>' +
                            '</div>' +
                            '<a data-product-index="' + i + '" class="product-remove">Remover</a>' +
                            '</div>' +
                            '</div>' +
                            '</li>');
        
                        //if (reward > 0) {
                        //	$('li[data-product-index="' + i + '"] .product-info').append('<div class="reward"><p>Cashback de ' + NewCart.fixPrice(reward) + '</p></div>');
                        //	$('li[data-product-index="' + i + '"] .product-info').append('<div class="reward"><p>DoaÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â§ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â£o de ' + NewCart.fixPrice(sellingPrice * 0.1) + '</p></div>');
                        //}
        
                    });
                    $('.mini-cart-bottom-total span').html(NewCart.fixPrice(orderForm.value));
                    if (orderForm.value < 100000) {
                        $('.mini-cart-bottom-frete').hide();
                    } else {
                        $('.mini-cart-bottom-frete').show();
        
                    }
                } else {
                    $('.mini-cart-wrapper').addClass('empty')
                }
                $('.mini-cart-icon-mob-qtd').html(numItemsInCart);
                $('.mini-cart-products').append('<span class="updated" style="display:none"></span>');
        
            },
            addToCartProductPage: (t, pageType) => { 
                if(pageType == 'productPage' || pageType == 'categoryPage'){
                    var href = t.target.href;
                    var produto = t.target
                
        
                if (href.indexOf("Por favor, selecione o modelo desejado.") === -1) {
                    $('a.buy-button.buy-button-ref').addClass('ldng-active');
                    if (pageType == 'productPage') {
                        var sku = href.substring(href.indexOf('sku=') + 4, href.indexOf('&qty'));
                        var qtd = document.getElementById('productQty').value;
        
                        if (vtxctx["departmentyId"] == "1000029") {
                            if (vtxctx["categoryId"] == "1000030" || vtxctx["categoryId"] == "1000033") {
                                if ($('.selectUn-Cx option')[1].selected) {
                                    qtd = qtd * 6;
                                    $('.comprarCaixa.buy-button.buy-button-ref').addClass('ldng-active');
                                }
                            }
                            if (vtxctx["categoryId"] == "1000031") {
                                if ($('.selectUn-Cx option')[1].selected) {
                                    qtd = qtd * 12;
                                    $('.comprarCaixa.buy-button.buy-button-ref').addClass('ldng-active');
                                }
                            }
                            if ($('.selectUn-Cx option')[0].selected) {
                                qtd = qtd * 1;
                                $('.comprarUnidade.buy-button.buy-button-ref').addClass('ldng-active');
                            }
                        }
                    }
                } else {
                    alert('Por favor, selecione o modelo desejado.');
                }
                    if (pageType == 'categoryPage') {
                        var pdt = $(produto).parent();
                        var sku = pdt.find('.buy-button-normal')[0].id;
                        var qtd = pdt.find('.product-main-info-price-productQty')[0].value;
        
                        if (pdt.find('.selectUn-Cx option')[0].selected) {
                            if (pdt.find('.shelfcategory')[0].innerText == 'Azeites') {
                                qtd = qtd * 12;
                            } else {
                                qtd = qtd * 6;
                            }
                        } else if (pdt.find('.selectUn-Cx option')[1].selected) {
                            qtd = qtd * 1;
                        }
                    }
                }
                    if (pageType == 'kitPage'){
                        var sku = $('.fake-prateleira-kit .sku-kit').text();
                        var qtd = 1
                    }
        
        
                    var item = {
                        id: sku,
                        quantity: qtd,
                        seller: '1'
                    };
                    try {
                        vtexjs.checkout.addToCart([item], null).done(function(orderForm) {
                            try {
                                console.log(orderForm);
                                NewCart.update(orderForm);
                                if (pageType == 'productPage') {
                                    NewCart.open();
                                    $('a.buy-button.buy-button-ref').removeClass('ldng-active');
                                    $('.buy-button.buy-button-ref').removeClass('ldng-active');
                                }
        
                            } catch (e) {
                                console.log('error addToCartProductPage, redirecting to cart');
                                window.location.href = href;
                            }
        
                        });
                    } catch (e) {
                        console.log('error addToCartProductPage, redirecting to cart');
                        window.location.href = href;
                    }
                
        
            },
            removeItem: (t) => {
                t.preventDefault();
                console.log('remove click');
                var i = t.srcElement.attributes['data-product-index'].value;
                $("li[data-product-index='" + i + "']").css('opacity', '.5');
                $('.product-remove').hide();
                vtexjs.checkout.getOrderForm().then(function(orderForm) {
                    var itemIndex = i
                    var item = orderForm.items[itemIndex];
                    var qtd = item.quantity;
                    var itemsToRemove = [{ "index": itemIndex, "quantity": qtd, }]
                    return vtexjs.checkout.removeItems(itemsToRemove);
                }).done(function(orderForm) {
                    NewCart.update(orderForm);
                });
            },
            events: () => {
                $('.n1-header__top__icones li:nth-of-type(2) a').click(function(t) {
                    if ($('.mini-cart-wrapper span.updated').length > 0) {
                        t.preventDefault();
                        NewCart.open();
                    }
                });
        
                $('.mini-cart-icon-mob a').click(function(t) {
                    if ($('.mini-cart-wrapper span.updated').length > 0) {
                        t.preventDefault();
                        NewCart.open();
                    }
                });
        
                $('.mini-cart-close-overlay').click(function() {
                    NewCart.close();
                });
        
                $('.mini-cart-close').click(function() {
                    NewCart.close();
                });
                
                $('#mini-cart-removeall').click(function() {
                    vtexjs.checkout.removeAllItems().done(function(orderForm) {
                        NewCart.update(orderForm);
                    });        	
                });
            
        
                //$('.product-remove').click(function(t) {
                //	t.preventDefault();
                //	NewCart.removeItem(t);
                //});
        
                $('.mini-cart-products').on('click', '.product-remove', function(t) {
                    t.preventDefault();
                    NewCart.removeItem(t);
                });
        
                $('.produto .buy-button.buy-button-ref').click(function(t) {
                    t.preventDefault();
                    pageType = 'productPage'
                    NewCart.addToCartProductPage(t, pageType);
                });
        
                $('body').on('click', '.seemore.buy-button.buy-button-ref', function(t) {
                    t.preventDefault();
                    pageType = 'categoryPage'
                    NewCart.addToCartProductPage(t, pageType);
                    NewCart.open();
                });
        
                $('.compraKit').click(function(t) {
                    t.preventDefault();
                    pageType = 'kitPage'
                   
                    NewCart.addToCartProductPage(t, pageType);
        
                    // item = $(' .shelfcategory + .a-vitrine')
                    // function task(i) {
                    //     setTimeout(() => {
                    //         t.target = item[i]
                    //         NewCart.addToCartProductPage(t, pageType);
                    //     }, 500 * i)
                    // }
                    // for (i = 0; i < item.length; i++) {
                    //     task(i)
                    // }
                    NewCart.open();
                });
        
            },
            fixPrice: (price) => { 
                var np = '';
                p = (price * .01).toFixed(2).replace('.', ',');
                if (p.split(',')[0].length == 4) {
                    np = 'R$ ' + p[0] + '.' + p.substring(1, p.length);
                } else if (p.split(',')[0].length == 5) {
                    np = 'R$ ' + p.substring(0, 2) + '.' + p.substring(2, p.length)
                } else {
                    np = 'R$ ' + p;
                }
                return np;
            },
            qtdProductAdega: () => {
                if ($('body').hasClass('produto') != true) {
                    $("body").on('click', '.product-main-info-price-buttonUp',
                        (o) => {
                            o.preventDefault()
                            e = $($(o.target).parent().parent().find('.product-main-info-price-productQty')[0]);
                            t = parseInt(e.val(), 10);
                            t++
                            e.attr("value", t)
                        })
                    $("body").on('click', '.product-main-info-price-buttonDown',
                        (o) => {
                            o.preventDefault()
                            e = $($(o.target).parent().parent().find('.product-main-info-price-productQty')[0]);
                            t = parseInt(e.val(), 10);
                            t > 1 && (t--, e.attr("value", t))
                        })
                }
            }
        };

        // Instanciando a funcao
        $(document).ready(NewCart.init);
        let windowLoad = function () {
            NewCart.windowOnload();
        };
        $(window).load(windowLoad);
        $(document).ajaxStop(NewCart.ajaxStop);
        
    } catch (e) {
        console.log("Erro na instância do [NewCommon]: ", e);
    }

})();

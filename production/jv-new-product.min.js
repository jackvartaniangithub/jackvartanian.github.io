(function () {

    try {

        let NewProduct = {
            init: () => {
                NewProduct.verifyTypeProduct();
                NewProduct.applyChangesPrices();
                NewProduct.getInfoProduct();
                NewProduct.applySlideToggleInInfomartions();
                NewProduct.quantityProductToCart();
                NewProduct.addProductCart();
                NewProduct.applyConfigSelectSku();
            },
            windowOnload: () => {},
            ajaxStop: () => {},
            verifyTypeProduct: () => {
                if (vtxctx.categoryId == '1000030') {
                    $(".aside-wrapper.joias").hide();
                } else {
                    $(".aside-wrapper.adegas").hide();
                }
            },
            getInfoProduct: () => {
                $("#include, ul.thumbs").addClass("hide-block-image");
                // $('<div id="jv-prodimage-load"><img src="https://jackvartaniangithub.github.io/production/jv-spinner-product-image.gif" /></div>').prependTo($("#show"));

                let id = skuJson.productId;
                $.ajax({
                    type: "GET",
                    url: `/api/catalog_system/pub/products/search/?fq=productId:${id}`,
                    dataType: "json",
                    contentType: "application/json",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/vnd.vtex.ds.v10+json"
                    }
                }).done(function (response) {
                    console.log(response[0]);
                    NewProduct.buildBigThumbs(response[0]);

                    if (vtxctx.categoryId == '1000030') {
                        NewProduct.buildDescriptionsAdegas(response[0]);
                    } else {
                        NewProduct.buildDescriptionJoias(response[0]);
                    }
                });
            },
            buildBigThumbs: (response) => {
                if (response.items[0].images.length <= 3) {
                    $("#show").addClass("no-slick");
                    return;
                }
                $("#show").addClass("jv-with-slick");

                let listThumbs = '';
                response.items[0].images.forEach(item => {
                    let src = item.imageTag.replace(/~/g, "");
                    src = src.replace(/#width#-#height#/g, "450-450");
                    src = src.replace(/width="#width#" height="#height#"/g, "");
                    let srcZoom = $(src);
                    srcZoom = srcZoom.attr("src");
                    srcZoom = srcZoom.replace(/450-450/g, "1000-1000");
                    let thumb = `<div class="jv-bigthumbs-block"><a class="jqzoom" href="${srcZoom}">${src}</a></div>`;
                    listThumbs = listThumbs + thumb;
                });
                let block = `<div class="jv-bigthumbs">${listThumbs}</div>`;
                $("#include").html(block);

                console.log($(".jv-bigthumbs-block img").length);
                $(".jqzoom").jqzoom({
                    zoomType: "standard",
                    zoomWidth: 500, 
                    zoomHeight: 500,
                    preloadImages: true
                });

                NewProduct.applySlickImageAndThumbs();

            },
            applySlickImageAndThumbs: () => {
                let wrapper = $('.jv-bigthumbs');
                let wrapperThumbs = $('#show .thumbs');
                wrapper.each(function () {
                    $(this).find('.slick-arrow').wrapAll('<div class="slick-nav" />');
                });
                wrapper.slick({
                    slidesToShow: 1,
                    slidesToScroll: 1,
                    arrows: true,
                    fade: true,
                    asNavFor: $('#show .thumbs')
                });
                wrapperThumbs.not('.slick-initialized').slick({
                    slidesToShow: 3,
                    slidesToScroll: 1,
                    asNavFor: $('.jv-bigthumbs'),
                    arrows: true,
                    dots:false,
                    centerMode: true,
                    focusOnSelect: true
                });

                setTimeout(function() {
                    $("#jv-prodimage-load").remove();
                    $("#include, ul.thumbs").removeClass("hide-block-image");
                }, 1500);
            },
            applyChangesPrices: () => {
                if (vtxctx.categoryId != '1000030') {
                    fixPrice = function (price) {
                        var np = '';
                        p = price.toFixed(2).replace('.', ',');
                        if (p.split(',')[0].length == 4) {
                            np = 'R$ ' + p[0] + '.' + p.substring(1, p.length);
                        } else if (p.split(',')[0].length == 5) {
                            np = 'R$ ' + p.substring(0, 2) + '.' + p.substring(2, p.length)
                        } else {
                            np = 'R$ ' + p;
                        }
                        return np;
                    }
    
                    let price = `<em class="jv-price-boleto-pix">Ou <strong>${fixPrice(parseInt(dataLayer[0].productPriceTo) * .9)} "</strong> no boleto, PIX ou transferência</em>`;
                    $(price).appendTo($(".descricao-preco"));
                    let priceInstallments = $(".descricao-preco .price-installments").first();
                    let text = priceInstallments.text();
                    text = text.replace("ou", " em até");
                    priceInstallments.text(text);

                } else if (vtxctx.categoryId == '1000030') {
                    let skuPrice = skuJson.skus[0].bestPrice;
                    let price = skuPrice - (skuPrice * 0.05); 
                    price = orionFormatPrice(price / 100, 2, ",", ".");
                    $(".price-box-unitys").text(`R$ ${price}`);
                }
            },
            applySlideToggleInInfomartions: () => {
                $(".informations-section span").on("click", function (e) {
                    e.preventDefault();

                    let $t = $(this);
                    $t.toggleClass("active");
                    $t.next().slideToggle();
                });
            },
            buildDescriptionJoias: (response) => {
                $("#jv-details-product").html(`<p>${response.description}</p>`);
                if (response["Cuidados com a peça"] && response["Cuidados com a peça"][0]) {
                    $("#jv-warnings-product").html(`<p>${response["Cuidados com a peça"][0]}</p>`);
                }   
            },
            buildDescriptionsAdegas: (response) => {
                let wrapper = $(".block.wine-resume");
                let listOne = '';
                if (response["Porcentagem Das"] && response["Porcentagem Das"][0]) {
                    let li = `
                        <li>
                            <strong>Porcentagem das: </strong>
                            <span>${response["Porcentagem Das"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }
                if (response["Uvas"] && response["Uvas"][0]) {
                    let li = `
                        <li>
                            <strong>Uvas: </strong>
                            <span>${response["Uvas"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }
                if (response["Vinícola"] && response["Vinícola"][0]) {
                    let li = `
                        <li>
                            <strong>Vinícola:  </strong>
                            <span>${response["Vinícola"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }
                if (response["Teor alcoólico"] && response["Teor alcoólico"][0]) {
                    let li = `
                        <li>
                            <strong>Teor alcoólico: </strong>
                            <span>${response["Teor alcoólico"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }

                if (response["Uva"] && response["Uva"][0]) {
                    let li = `
                        <li>
                            <strong>Uva: </strong>
                            <span>${response["Uva"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }
                if (response["Região"] && response["Região"][0]) {
                    let li = `
                        <li>
                            <strong>Região: </strong>
                            <span>${response["Região"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }
                if (response["Safra"] && response["Safra"][0]) {
                    let li = `
                        <li>
                            <strong>Safra: </strong>
                            <span>${response["Safra"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }

                if (response["Harmoniza com"] && response["Harmoniza com"][0]) {
                    let li = `
                        <li>
                            <strong>Harmoniza com: </strong>
                            <span>${response["Harmoniza com"][0]}</span>
                        </li>
                    `;
                    listOne += li;
                }

                let lists = `<ul>${listOne}</ul>`;
                wrapper.html(lists);

                $(".block.shortdescription").html(`<p>${response.description}</p>`);
            },
            applyConfigSelectSku: () => {
                // Joias ou qualquer outra
                if (vtxctx.departmentyId == '1000022' || vtxctx.departmentyId != '1000029') {
                    let skuSelector = $(".sku-selector-container.sku-selector-container-0");
                    console.log("Passei 1!");
                    console.log(skuSelector.length);
                    if (skuSelector.children().length == 0) {
                        return;
                    }

                    $(".block.skuselection select").find("option").first().text('Tamanho');
                } 
                // Adega
                else if (vtxctx.departmentyId == '1000029') {
                    console.log("Vinhos");
                }
            },
            quantityProductToCart: () => {
                // Joias ou qualquer outra
                if (vtxctx.departmentyId == '1000022' || vtxctx.departmentyId != '1000029') {
                    // Config Quantidade Joias
                    let inputQtt = $(".buybutton-qtt input");
                    let buyButton = $(".buybutton-wrapper .buy-button.buy-button-ref");
                    let thisQttVal = 1;
                    $(".buybutton-qtt-inputs span").on("click", function (e) {
                        e.preventDefault();
                        thisQttVal = inputQtt.val();
                        thisQttVal = parseInt(thisQttVal);
                        let updateUrl = buyButton.attr("href");
                        if ($(this).is(".inputs-up")) {
                            thisQttVal = parseInt(thisQttVal) + parseInt(1);
                            inputQtt.val(thisQttVal);
                            updateUrl = updateUrl.replace(/qty=\d+/g, `qty=${thisQttVal}`);
                            buyButton.attr("href", updateUrl);
                        } else if ($(this).is(".inputs-down")) {
                            if (thisQttVal == 1) {
                                return;
                            }
                            thisQttVal = parseInt(thisQttVal) - parseInt(1);
                            inputQtt.val(thisQttVal);
                            updateUrl = updateUrl.replace(/qty=\d+/g, `qty=${thisQttVal}`);
                            buyButton.attr("href", updateUrl);
                        }
                    });
                } 
                // Adega
                else if (vtxctx.departmentyId == '1000029') {

                    // Config Adegas
                    let inputQttAdegas = $(".unity-box-input input");
                    let thisQttValAdegas = 1;
                    $(".block-arrows span").on("click", function (e) {
                        e.preventDefault();
                        thisQttValAdegas = inputQttAdegas.val();
                        thisQttValAdegas = parseInt(thisQttValAdegas);
                        if ($(this).is(".arrows-to-up")) {
                            thisQttValAdegas = parseInt(thisQttValAdegas) + parseInt(1);
                            inputQttAdegas.val(thisQttValAdegas);
                        } else if ($(this).is(".arrows-to-down")) {
                            if (thisQttValAdegas == 1) {
                                return;
                            }
                            thisQttValAdegas = parseInt(thisQttValAdegas) - parseInt(1);
                            inputQttAdegas.val(thisQttValAdegas);
                        }
                    });

                }
            },
            addProductCart: () => {
                // Joias ou qualquer outra
                if (vtxctx.departmentyId == '1000022' || vtxctx.departmentyId != '1000029') {
                    // Buy Button Joias
                    let buyButton = $(".buybutton-wrapper .buy-button.buy-button-ref");
                    buyButton.on("click", function (e) {
                        e.preventDefault();
                        let $t = $(this);
                        let skuId = NewProduct.returnSku($(this));
                        console.log("A");
                        if (skuId == 'alerta') {
                            console.log("B");
                            alert('Por favor, selecione o modelo desejado.');
                            return false;
                        } else {
                            console.log("C");
                            let qtt = $("#jv-joias-qtt-input").val();
                            $t.addClass("active-load");
                            console.log(skuId);
                            NewProduct.sendProductToOrderForm(skuId, qtt, $t);
                        }
                    })
                } 
                else if (vtxctx.departmentyId == '1000029') {
                    // BuyButton Adegas
                    let buyButtonAdegas = $(".block.buybutton .buy-button.buy-button-ref");
                    buyButtonAdegas.on("click", function (e) {
                        e.preventDefault();
                        let $t = $(this);
                        let valueUnity = $('#jv-select-unity-box option:selected').val();
                        let skuId = NewProduct.returnSku($(this));
                        $t.addClass("active-load"); 

                        if (valueUnity == 'unidade') {
                            let thisQtt = $("#jv-adegas-qtt-input").val();
                            let updateUrl = $(this).attr("href");
                            updateUrl = updateUrl.replace(/qty=\d+/g, `qty=${thisQtt}`);
                            $(this).attr("href", updateUrl);
                            NewProduct.sendProductToOrderForm(skuId, thisQtt, $t);
                        } 
                        else if (valueUnity == 'caixa') {
                            let thisQtt = $("#jv-adegas-qtt-input").val();
                            thisQtt = thisQtt * 6;
                            let updateUrl = $(this).attr("href");
                            updateUrl = updateUrl.replace(/qty=\d+/g, `qty=${thisQtt}`);
                            $(this).attr("href", updateUrl);

                            NewProduct.sendProductToOrderForm(skuId, thisQtt, $t);
                        }
                    })
                }

            },
            sendProductToOrderForm: (skuId, inputQtt, buyButton) => {
                let item = {
                    id: skuId,
                    quantity: inputQtt,
                    seller: '1'
                };
                vtexjs.checkout.getOrderForm().done(function(orderForm) {
                    vtexjs.checkout.addToCart([item], null).done(function(newOrderForm) {
                        miniCartFunctions.update(newOrderForm);
                        $(".mini-cart-wrapper").addClass("active");
                        $(".mini-cart-close-overlay").fadeIn(400, "linear");
                        buyButton.removeClass("active-load");
                    })
                });
            },
            returnSku: (thisButton) => {
                let url = thisButton.attr("href");
                if (url == "javascript:alert('Por favor, selecione o modelo desejado.');") {
                    return 'alerta';
                }
                skuId = url.match(/(?<=sku=).*(?=&qty)/g)[0];
                return skuId;
            }
        };

        // Instanciando a funcao
        $(document).ready(NewProduct.init);
        let windowLoad = function () {
            NewProduct.windowOnload();
        };
        $(window).load(windowLoad);
        $(document).ajaxStop(NewProduct.ajaxStop);

    } catch (e) {
        console.log("Erro na instância do [NewProduct]: ", e);
    }

})();

// (Utils) Formatação de preço
function orionFormatPrice(n,t,e,i){n=(n+"").replace(/[^0-9+\-Ee.]/g,""),n=isFinite(+n)?+n:0,i=void 0===i?",":i,e=void 0===e?".":e;var r="";r=function(n,t){var e=Math.pow(10,t);return""+(Math.round(n*e)/e).toFixed(t)};return 3<(r=((t=isFinite(+t)?Math.abs(t):0)?r(n,t):""+Math.round(n)).split("."))[0].length&&(r[0]=r[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,i)),(r[1]||"").length<t&&(r[1]=r[1]||"",r[1]+=Array(t-r[1].length+1).join("0")),r.join(e)}